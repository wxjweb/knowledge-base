(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{370:function(e,n,l){"use strict";l.r(n);var a=l(43),t=Object(a.a)({},(function(){var e=this,n=e.$createElement,l=e._self._c||n;return l("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[l("h1",{attrs:{id:"postgresql-序列（sequence）"}},[l("a",{staticClass:"header-anchor",attrs:{href:"#postgresql-序列（sequence）"}},[e._v("#")]),e._v(" PostgreSQL 序列（SEQUENCE）")]),e._v(" "),l("p",[e._v("一、简介")]),e._v(" "),l("p",[e._v("序列对象（也叫序列生成器）就是用CREATE SEQUENCE 创建的特殊的单行表。一个序列对象通常用于为行或者表生成唯一的标识符。")]),e._v(" "),l("p",[e._v("二、创建序列")]),e._v(" "),l("p",[e._v("方法一：直接在表中指定字段类型为serial 类型")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v('david=# create table tbl_xulie (\ndavid(# id serial,\ndavid(# name text);\nNOTICE:  CREATE TABLE will create implicit sequence "tbl_xulie_id_seq" for serial column "tbl_xulie.id"\nCREATE TABLE\ndavid=#\n')])])]),l("p",[e._v("方法二：先创建序列名称，然后在新建的表中列属性指定序列就可以了，该列需int 类型")]),e._v(" "),l("p",[e._v("创建序列的语法：")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("\nCREATE [ TEMPORARY | TEMP ] SEQUENCE name [ INCREMENT [ BY ] increment ]\n    [ MINVALUE minvalue | NO MINVALUE ] [ MAXVALUE maxvalue | NO MAXVALUE ]\n    [ START [ WITH ] start ] [ CACHE cache ] [ [ NO ] CYCLE ]\n    [ OWNED BY { table.column | NONE } ]\n\n\n")])])]),l("p",[e._v("实例：")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# create sequence tbl_xulie2_id_seq increment by 1 minvalue 1 no maxvalue start with 1;     \nCREATE SEQUENCE\ndavid=#\n")])])]),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# create table tbl_xulie2 (\ndavid(# id int4 not null default nextval('tbl_xulie2_id_seq'),\ndavid(# name text);\nCREATE TABLE\ndavid=# \n")])])]),l("p",[e._v("三、查看序列")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# \\d tbl_xulie\n                         Table \"public.tbl_xulie\"\n Column |  Type   |                       Modifiers                        \n--------+---------+--------------------------------------------------------\n id     | integer | not null default nextval('tbl_xulie_id_seq'::regclass)\n name   | text    | \n\ndavid=# \\d tbl_xulie2\n                         Table \"public.tbl_xulie2\"\n Column |  Type   |                        Modifiers                        \n--------+---------+---------------------------------------------------------\n id     | integer | not null default nextval('tbl_xulie2_id_seq'::regclass)\n name   | text    | \n\ndavid=#\n")])])]),l("p",[e._v("查看序列属性")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v('复制代码\n\ndavid=# \\d tbl_xulie_id_seq\n      Sequence "public.tbl_xulie_id_seq"\n    Column     |  Type   |        Value        \n---------------+---------+---------------------\n sequence_name | name    | tbl_xulie_id_seq\n last_value    | bigint  | 1\n start_value   | bigint  | 1\n increment_by  | bigint  | 1\n max_value     | bigint  | 9223372036854775807\n min_value     | bigint  | 1\n cache_value   | bigint  | 1\n log_cnt       | bigint  | 0\n is_cycled     | boolean | f\n is_called     | boolean | f\nOwned by: public.tbl_xulie.id\n\ndavid=#\n')])])]),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# select * from tbl_xulie2_id_seq;\n   sequence_name   | last_value | start_value | increment_by |      max_value      | min_value | cache_value | log_cnt | is_cycled | is_called \n-------------------+------------+-------------+--------------+---------------------+-----------+-------------+---------+-----------+-----------\n tbl_xulie2_id_seq |          1 |           1 |            1 | 9223372036854775807 |         1 |           1 |       0 | f         | f\n(1 row)\n\ndavid=# \n")])])]),l("p",[e._v("四、序列应用")]),e._v(" "),l("p",[e._v("4.1 在INSERT 命令中使用序列")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'David');      \nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Sandy');\nINSERT 0 1\ndavid=# select * from tbl_xulie;\n id | name  \n----+-------\n  1 | David\n  2 | Sandy\n(2 rows)\n\ndavid=# \n")])])]),l("p",[e._v("4.2 数据迁移后更新序列")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# truncate tbl_xulie;\nTRUNCATE TABLE\ndavid=# \ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Sandy');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'David');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Eagle');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Miles');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Simon');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Rock'); \nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Peter');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Sally');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Nicole');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Monica');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Renee'); \nINSERT 0 1\ndavid=# select * from tbl_xulie;\n id |  name  \n----+--------\n 15 | Sandy\n 16 | David\n 17 | Eagle\n 18 | Miles\n 19 | Simon\n 20 | Rock\n 21 | Peter\n 22 | Sally\n 23 | Nicole\n 24 | Monica\n 25 | Renee\n(11 rows)\n\ndavid=# copy tbl_xulie to '/tmp/tbl_xulie.sql';\nCOPY 11\ndavid=# truncate tbl_xulie;\nTRUNCATE TABLE\ndavid=# alter sequence tbl_xulie_id_seq restart with 100;\nALTER SEQUENCE\ndavid=# select currval('tbl_xulie_id_seq');\n currval \n---------\n      25\n(1 row)\n\ndavid=# select nextval('tbl_xulie_id_seq');\n nextval \n---------\n     100\n(1 row)\n\ndavid=# select nextval('tbl_xulie_id_seq');\n nextval \n---------\n     101\n(1 row)\n\ndavid=# begin;\nBEGIN\ndavid=# copy tbl_xulie from '/tmp/tbl_xulie.sql';\nCOPY 11\ndavid=# select setval('tbl_xulie_id_seq', max(id)) from tbl_xulie;\n setval \n--------\n     25\n(1 row)\n\ndavid=# end;\nCOMMIT\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Flash');\nINSERT 0 1\ndavid=# select * from tbl_xulie;\n id |  name  \n----+--------\n 15 | Sandy\n 16 | David\n 17 | Eagle\n 18 | Miles\n 19 | Simon\n 20 | Rock\n 21 | Peter\n 22 | Sally\n 23 | Nicole\n 24 | Monica\n 25 | Renee\n 26 | Flash\n(12 rows)\n\ndavid=# select nextval('tbl_xulie_id_seq');\n nextval \n---------\n      27\n(1 row)\n\ndavid=#\n")])])]),l("p",[e._v("五、序列函数")]),e._v(" "),l("p",[e._v("下面序列函数，为我们从序列对象中获取最新的序列值提供了简单和并发读取安全的方法。")]),e._v(" "),l("p",[l("img",{attrs:{src:"https://note.youdao.com/yws/public/resource/2a20757ad59ce9e71b04a45b83d5d74a/xmlnote/F3C08D7FBF384DB7B30D40E8F790EAA9/9444",alt:"image"}})]),e._v(" "),l("p",[e._v("5.1 查看下一个序列值")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# select nextval('tbl_xulie_id_seq');\n nextval \n---------\n       3\n(1 row)\n\ndavid=# select nextval('tbl_xulie_id_seq');\n nextval \n---------\n       4\n(1 row)\n\ndavid=# \n")])])]),l("p",[e._v("5.2 查看序列最近使用值")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# select nextval('tbl_xulie_id_seq');\n nextval \n---------\n       4\n(1 row)\n\ndavid=# select currval('tbl_xulie_id_seq');\n currval \n---------\n       4\n(1 row)\n\ndavid=# select currval('tbl_xulie_id_seq');\n currval \n---------\n       4\n(1 row)\n\ndavid=# \n")])])]),l("p",[e._v("5.3 重置序列")]),e._v(" "),l("p",[e._v("方法一：使用序列函数")]),e._v(" "),l("p",[e._v("a. setval(regclass, bigint)")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# truncate tbl_xulie;\nTRUNCATE TABLE\ndavid=# select setval('tbl_xulie_id_seq', 1);\n setval \n--------\n      1\n(1 row)\n\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Sandy');                  \nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'David');     \nINSERT 0 1\ndavid=# select * from tbl_xulie;\n id | name  \n----+-------\n  2 | Sandy\n  3 | David\n(2 rows)\n\ndavid=# select currval('tbl_xulie_id_seq');\n currval \n---------\n       3\n(1 row)\n\ndavid=# select nextval('tbl_xulie_id_seq');\n nextval \n---------\n       4\n(1 row)\n\ndavid=# \n")])])]),l("p",[e._v("b. setval(regclass, bigint, boolean)")]),e._v(" "),l("p",[e._v("b.1 setval(regclass, bigint, true)")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# truncate tbl_xulie;\nTRUNCATE TABLE\ndavid=# select setval('tbl_xulie_id_seq', 1, true);\n setval \n--------\n      1\n(1 row)\n\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Sandy');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'David');\nINSERT 0 1\ndavid=# select * from tbl_xulie;\n id | name  \n----+-------\n  2 | Sandy\n  3 | David\n(2 rows)\n\ndavid=#\n")])])]),l("p",[e._v("效果同a. setval(regclass, bigint)")]),e._v(" "),l("p",[e._v("b.2 setval(regclass, bigint, false)")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# truncate tbl_xulie;\nTRUNCATE TABLE\ndavid=# select setval('tbl_xulie_id_seq', 1, false);\n setval \n--------\n      1\n(1 row)\n\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Sandy');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'David');\nINSERT 0 1\ndavid=# select * from tbl_xulie;\n id | name  \n----+-------\n  1 | Sandy\n  2 | David\n(2 rows)\n\ndavid=# \n\n复制代码\n")])])]),l("p",[e._v("方法二：修改序列")]),e._v(" "),l("p",[e._v("修改序列的语法：")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("ALTER SEQUENCE name [ INCREMENT [ BY ] increment ]\n    [ MINVALUE minvalue | NO MINVALUE ] [ MAXVALUE maxvalue | NO MAXVALUE ]\n    [ START [ WITH ] start ]\n    [ RESTART [ [ WITH ] restart ] ]\n    [ CACHE cache ] [ [ NO ] CYCLE ]\n    [ OWNED BY { table.column | NONE } ]\nALTER SEQUENCE name OWNER TO new_owner\nALTER SEQUENCE name RENAME TO new_name\nALTER SEQUENCE name SET SCHEMA new_schema\n")])])]),l("p",[e._v("实例：")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# truncate tbl_xulie;\nTRUNCATE TABLE\ndavid=# alter sequence tbl_xulie_id_seq restart with 0;\nERROR:  RESTART value (0) cannot be less than MINVALUE (1)\ndavid=# alter sequence tbl_xulie_id_seq restart with 1;\nALTER SEQUENCE\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'David');\nINSERT 0 1\ndavid=# insert into tbl_xulie values (nextval('tbl_xulie_id_seq'), 'Sandy');\nINSERT 0 1\ndavid=# select * from tbl_xulie;\n id | name  \n----+-------\n  1 | David\n  2 | Sandy\n(2 rows)\n\ndavid=# select nextval('tbl_xulie_id_seq');\n nextval \n---------\n       3\n(1 row)\n\ndavid=# \n")])])]),l("p",[e._v("六、删除序列")]),e._v(" "),l("p",[e._v("语法：")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("DROP SEQUENCE [ IF EXISTS ] name [, ...] [ CASCADE | RESTRICT ]\n")])])]),l("p",[e._v("当有表字段使用到PG序列时，不能直接删除。")]),e._v(" "),l("div",{staticClass:"language- extra-class"},[l("pre",{pre:!0,attrs:{class:"language-text"}},[l("code",[e._v("david=# drop sequence tbl_xulie2_id_seq;\nERROR:  cannot drop sequence tbl_xulie2_id_seq because other objects depend on it\nDETAIL:  default for table tbl_xulie2 column id depends on sequence tbl_xulie2_id_seq\nHINT:  Use DROP ... CASCADE to drop the dependent objects too.\ndavid=# drop table tbl_xulie2;\nDROP TABLE\ndavid=# drop sequence tbl_xulie2_id_seq;\nDROP SEQUENCE\ndavid=# \n")])])]),l("p",[e._v("说明：对于序列是由建表时指定serial 创建的，删除该表的同时，对应的序列也会被删除。")])])}),[],!1,null,null,null);n.default=t.exports}}]);