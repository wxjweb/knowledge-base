<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>devmd与bad | 知识库</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="知识库">
    <link rel="preload" href="/assets/css/0.styles.fda5222c.css" as="style"><link rel="preload" href="/assets/js/app.0a996f13.js" as="script"><link rel="preload" href="/assets/js/2.4c21bbc0.js" as="script"><link rel="preload" href="/assets/js/31.d48daed0.js" as="script"><link rel="prefetch" href="/assets/js/10.3594c7f7.js"><link rel="prefetch" href="/assets/js/11.01344d83.js"><link rel="prefetch" href="/assets/js/12.5bd86c9a.js"><link rel="prefetch" href="/assets/js/13.c8326861.js"><link rel="prefetch" href="/assets/js/14.9e6f6bc6.js"><link rel="prefetch" href="/assets/js/15.450fcbfa.js"><link rel="prefetch" href="/assets/js/16.8b0986e9.js"><link rel="prefetch" href="/assets/js/17.7463bea7.js"><link rel="prefetch" href="/assets/js/18.a1b79c77.js"><link rel="prefetch" href="/assets/js/19.55ad8e46.js"><link rel="prefetch" href="/assets/js/20.e4715d5e.js"><link rel="prefetch" href="/assets/js/21.10f05590.js"><link rel="prefetch" href="/assets/js/22.54fb0f96.js"><link rel="prefetch" href="/assets/js/23.77debcd1.js"><link rel="prefetch" href="/assets/js/24.99d07cb7.js"><link rel="prefetch" href="/assets/js/25.62ebdd7a.js"><link rel="prefetch" href="/assets/js/26.02cc01ab.js"><link rel="prefetch" href="/assets/js/27.c49ed669.js"><link rel="prefetch" href="/assets/js/28.327b6fde.js"><link rel="prefetch" href="/assets/js/29.e10fc75a.js"><link rel="prefetch" href="/assets/js/3.6a43814f.js"><link rel="prefetch" href="/assets/js/30.f855b085.js"><link rel="prefetch" href="/assets/js/32.01394b14.js"><link rel="prefetch" href="/assets/js/33.ab4da7b7.js"><link rel="prefetch" href="/assets/js/34.a9f6dd8d.js"><link rel="prefetch" href="/assets/js/35.03aa9a0f.js"><link rel="prefetch" href="/assets/js/36.1d1283e5.js"><link rel="prefetch" href="/assets/js/37.3fdce327.js"><link rel="prefetch" href="/assets/js/38.46c17362.js"><link rel="prefetch" href="/assets/js/39.ad677dec.js"><link rel="prefetch" href="/assets/js/4.81ad81d8.js"><link rel="prefetch" href="/assets/js/40.b198e092.js"><link rel="prefetch" href="/assets/js/41.7a914640.js"><link rel="prefetch" href="/assets/js/5.0e673148.js"><link rel="prefetch" href="/assets/js/6.fa57201c.js"><link rel="prefetch" href="/assets/js/7.6d61ac15.js"><link rel="prefetch" href="/assets/js/8.76a17660.js"><link rel="prefetch" href="/assets/js/9.6ac09fc2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fda5222c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">知识库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/python/" class="nav-link">
  python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/talk.html" class="nav-link">
  talk
</a></li><li class="dropdown-item"><!----> <a href="/extra/" class="nav-link">
  other
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/wxjweb" target="_blank" rel="noopener noreferrer" class="nav-link external">
  FAQ
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/python/" class="nav-link">
  python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/talk.html" class="nav-link">
  talk
</a></li><li class="dropdown-item"><!----> <a href="/extra/" class="nav-link">
  other
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/wxjweb" target="_blank" rel="noopener noreferrer" class="nav-link external">
  FAQ
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>welcome</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/welcome/brief introduction.html" class="sidebar-link">brief introduction</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Django</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Shell</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Leetcode</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tools</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>talk</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>other</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="devmd与bad"><a href="#devmd与bad" class="header-anchor">#</a> devmd与bad</h1> <div class="language-python extra-class"><pre class="language-python"><code>X<span class="token punctuation">:</span>\ba3\src\basite\task\<span class="token builtin">object</span>\ba_sec_tpl_task<span class="token punctuation">.</span>py
定义任务类

<span class="token keyword">class</span> <span class="token class-name">baSecTplTask</span><span class="token punctuation">(</span>DeviceTask<span class="token punctuation">,</span> DBTask<span class="token punctuation">)</span><span class="token punctuation">:</span>
    last_updated_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> job_id<span class="token punctuation">,</span> job_name<span class="token punctuation">,</span> task_id<span class="token punctuation">,</span> task_type<span class="token punctuation">,</span> plan<span class="token punctuation">,</span> ne_id<span class="token punctuation">,</span> parameters<span class="token punctuation">,</span> logger<span class="token operator">=</span>taskLog<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>baSecTplTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>job_id<span class="token punctuation">,</span> job_name<span class="token punctuation">,</span> task_id<span class="token punctuation">,</span> task_type<span class="token punctuation">,</span> plan<span class="token punctuation">,</span> ne_id<span class="token punctuation">,</span> parameters<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>diff_keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        baSecTplTask<span class="token punctuation">.</span>last_updated_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>seq <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>task_completed <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>config_type <span class="token operator">=</span> ba_TPL_SET

</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>X<span class="token punctuation">:</span>\ba3\src\basite\task\<span class="token builtin">object</span>\ba_sec_tpl_task<span class="token punctuation">.</span>py
任务开始

    <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>baSecTplTask<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        config_db <span class="token operator">=</span> SgDB<span class="token punctuation">(</span>logger<span class="token operator">=</span>self<span class="token punctuation">.</span>logger<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># get the config</span>
            c <span class="token operator">=</span> CommonMessage<span class="token punctuation">(</span>ne_id<span class="token operator">=</span>self<span class="token punctuation">.</span>ne_id<span class="token punctuation">,</span> category<span class="token operator">=</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;get_tpl_config&quot;</span><span class="token punctuation">,</span>
                              message_from<span class="token operator">=</span><span class="token string">&quot;tpl_config&quot;</span><span class="token punctuation">,</span> task_id<span class="token operator">=</span>self<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>set_progress<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            response_msg <span class="token operator">=</span> sync_invoke<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;response_msg: %s&quot;</span> <span class="token operator">%</span> response_msg<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token keyword">not</span> response_msg<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>error <span class="token operator">=</span> locale<span class="token punctuation">.</span>TASK_CANNOT_GET_CONFIG_FILE_REPLY_FROM_FW <span class="token operator">%</span> <span class="token punctuation">(</span>ne_info_cache<span class="token punctuation">.</span>get_single_ne_by_ne_id<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ne_id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'nename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> self

            parsed_response <span class="token operator">=</span> parser_common_message<span class="token punctuation">(</span>response_msg<span class="token punctuation">)</span>
            config_file <span class="token operator">=</span> parsed_response<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;file_name&quot;</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;device config file = [%s]&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>config_file<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> config_file<span class="token punctuation">:</span>
                target_file_path <span class="token operator">=</span> get_config_commit_data_path<span class="token punctuation">(</span>self<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> basename<span class="token punctuation">(</span>config_file<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;move config file for %s from %s to %s for config task&quot;</span> <span class="token operator">%</span>
                                 <span class="token punctuation">(</span>self<span class="token punctuation">.</span>ne_id<span class="token punctuation">,</span> config_file<span class="token punctuation">,</span> target_file_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
                shutil<span class="token punctuation">.</span>move<span class="token punctuation">(</span>config_file<span class="token punctuation">,</span> target_file_path<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>set_progress<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>message <span class="token operator">=</span> locale<span class="token punctuation">.</span>TASK_GET_CONFIG_SUCCESS
                self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;Move done. the config file is put in: %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>target_file_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    dict_of_device_moi <span class="token operator">=</span> load_config<span class="token punctuation">(</span>target_file_path<span class="token punctuation">,</span> ne_id<span class="token operator">=</span>self<span class="token punctuation">.</span>ne_id<span class="token punctuation">,</span> config_type<span class="token operator">=</span>self<span class="token punctuation">.</span>config_type<span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>set_progress<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>message <span class="token operator">=</span> locale<span class="token punctuation">.</span>TASK_GET_CONFIG_COMPLETED
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> msg<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token string">&quot;ERROR: parse device config to moi tree, msg = [%s]&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>error <span class="token operator">=</span> locale<span class="token punctuation">.</span>TASK_CONFIG_FILE_RETURNED_FROM_FW_IS_WRONG
                    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">&quot;didn't get config file&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;ERROR: response of the device [ne_id = %d] has no path of config file&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>ne_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>error <span class="token operator">=</span> locale<span class="token punctuation">.</span>TASK_CANNOT_GET_CONFIG_FILE_REPLY_FROM_FW <span class="token operator">%</span> <span class="token punctuation">(</span>ne_info_cache<span class="token punctuation">.</span>get_single_ne_by_ne_id<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ne_id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'nename'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">&quot;can't find the config_file&quot;</span><span class="token punctuation">)</span>

            config_db<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># get the diff file</span>
            diff <span class="token operator">=</span> self<span class="token punctuation">.</span>prepare_diff<span class="token punctuation">(</span>config_db<span class="token punctuation">,</span> dict_of_device_moi<span class="token punctuation">)</span>

            <span class="token comment"># write diff to diff file</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                diff_file_path <span class="token operator">=</span> get_config_commit_task_diff_file_path<span class="token punctuation">(</span>self<span class="token punctuation">.</span>task_id<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ne_id<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;write diff result to diff file&quot;</span><span class="token punctuation">)</span>
                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>diff_file_path<span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> diff_file<span class="token punctuation">:</span>
                    diff_file<span class="token punctuation">.</span>writelines<span class="token punctuation">(</span>diff<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> msg<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;open file [%s] error, msg = [%s]&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>diff_file_path<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>error <span class="token operator">=</span> locale<span class="token punctuation">.</span>TASK_INTERNAL_ERROR_WHEN_WRITE_DIFF_FILE_INTO_DISK
                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">&quot;diff config error&quot;</span><span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>set_progress<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>message <span class="token operator">=</span> locale<span class="token punctuation">.</span>TASK_CREATE_DIFF_SUCCESS

            <span class="token comment"># Initialize the sequence before the command is sent.</span>
            <span class="token comment"># For some times, the command is returned before the response is got.</span>
            self<span class="token punctuation">.</span>task_completed <span class="token operator">=</span> <span class="token boolean">False</span>
            self<span class="token punctuation">.</span>seq <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token comment"># wait util the responses are received.</span>
            self<span class="token punctuation">.</span>waiting <span class="token operator">=</span> <span class="token boolean">True</span>

            <span class="token comment"># commit diff file to device</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>set_progress<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>message <span class="token operator">=</span> locale<span class="token punctuation">.</span>TASK_START_TO_DEPLOY
                self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;commit diff file to dev&quot;</span><span class="token punctuation">)</span>
                c <span class="token operator">=</span> CommonMessage<span class="token punctuation">(</span>ne_id<span class="token operator">=</span>self<span class="token punctuation">.</span>ne_id<span class="token punctuation">,</span> category<span class="token operator">=</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;set_tpl_config&quot;</span><span class="token punctuation">,</span> payload<span class="token operator">=</span>diff_file_path<span class="token punctuation">,</span>
                                  ne_sn<span class="token operator">=</span>ne_info_cache<span class="token punctuation">.</span>get_ne_sn_by_ne_id<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ne_id<span class="token punctuation">,</span> config_db<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                  message_from<span class="token operator">=</span><span class="token string">&quot;tpl_config&quot;</span><span class="token punctuation">,</span> task_id<span class="token operator">=</span>self<span class="token punctuation">.</span>task_id<span class="token punctuation">)</span>
                response_msg <span class="token operator">=</span> asyc_invoke<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;response msg = [%s]&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>response_msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> msg<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>error <span class="token operator">=</span> locale<span class="token punctuation">.</span>TASK_SEND_DIFF_FILE_EXCEPTION
                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">&quot;diff config error&quot;</span><span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>log_task_start<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># add the timeout setting after the commands are sent.</span>
            self<span class="token punctuation">.</span>timeout_value <span class="token operator">=</span> <span class="token number">90</span>
            baSecTplTask<span class="token punctuation">.</span>last_updated_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> msg<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            config_db<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> self

</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>X<span class="token punctuation">:</span>\ba3\src\basite\device\common\common_message<span class="token punctuation">.</span>py
消息初始化

<span class="token keyword">class</span> <span class="token class-name">CommonMessage</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    The category could be monitor, common.
    For common category:
    1)load_config
    2)deploy_config
    3)common config

    For monitor:
    1)
    '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ne_id<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> ne_sn<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> category<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> payload<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                 vsys_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> message_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> message_from<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> common_json<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> task_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ne_id <span class="token operator">=</span> ne_id
        self<span class="token punctuation">.</span>category <span class="token operator">=</span> category
        self<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">=</span> <span class="token builtin">type</span>
        self<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload
        self<span class="token punctuation">.</span>vsys_id <span class="token operator">=</span> vsys_id
        self<span class="token punctuation">.</span>message_id <span class="token operator">=</span> message_id
        self<span class="token punctuation">.</span>message_from <span class="token operator">=</span> message_from
        self<span class="token punctuation">.</span>ne_sn <span class="token operator">=</span> ne_sn
        self<span class="token punctuation">.</span>common_json <span class="token operator">=</span> common_json
        self<span class="token punctuation">.</span>task_id <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0x8000</span><span class="token punctuation">,</span> <span class="token number">0xffff</span><span class="token punctuation">)</span> <span class="token keyword">if</span> task_id <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> task_id <span class="token operator">&amp;</span> <span class="token number">0x7fff</span>
    
    <span class="token keyword">def</span> <span class="token function">get_message_header</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        content <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        content<span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>category
        content<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token builtin">type</span>
        content<span class="token punctuation">[</span><span class="token string">'message_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>message_id
        content<span class="token punctuation">[</span><span class="token string">'vsys_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>vsys_id
        content<span class="token punctuation">[</span><span class="token string">'message_from'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>message_from
        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>ne_sn<span class="token punctuation">:</span>
            content<span class="token punctuation">[</span><span class="token string">'ne_sn'</span><span class="token punctuation">]</span> <span class="token operator">=</span> get_ne_sn_by_ne_id<span class="token punctuation">(</span>self<span class="token punctuation">.</span>ne_id<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>ne_sn <span class="token operator">=</span> content<span class="token punctuation">[</span><span class="token string">'ne_sn'</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            content<span class="token punctuation">[</span><span class="token string">'ne_sn'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>ne_sn
        content<span class="token punctuation">[</span><span class="token string">&quot;task_id&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>task_id
        <span class="token keyword">return</span> content

    <span class="token keyword">def</span> <span class="token function">get_message_body</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        content <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>category <span class="token operator">==</span> <span class="token string">'common'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'commit_config'</span><span class="token punctuation">,</span> <span class="token string">'commit_license'</span><span class="token punctuation">,</span> <span class="token string">&quot;tpl_config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                content<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>payload
            <span class="token keyword">elif</span> self<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">'common'</span><span class="token punctuation">:</span>
                content<span class="token punctuation">[</span><span class="token string">'common_json'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>common_json
        <span class="token keyword">return</span> content

    <span class="token keyword">def</span> <span class="token function">get_message_content</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        data<span class="token punctuation">[</span><span class="token string">'head'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>get_message_header<span class="token punctuation">(</span>get_new_message_id<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        data<span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>get_message_body<span class="token punctuation">(</span><span class="token punctuation">)</span>
        json_data <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">return</span> json_data


</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>X<span class="token punctuation">:</span>\ba3\src\basite\device\ipc\dev_ipc<span class="token punctuation">.</span>py
同步发送消息

<span class="token keyword">def</span> <span class="token function">sync_invoke</span><span class="token punctuation">(</span>common_message<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> invoke<span class="token punctuation">(</span>common_message<span class="token punctuation">,</span> multiprocessing<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>X<span class="token punctuation">:</span>\ba3\src\basite\device\ipc\dev_ipc<span class="token punctuation">.</span>py
消息下发

<span class="token comment"># the controller parameter could be Event object or callback method.</span>
<span class="token keyword">def</span> <span class="token function">invoke</span><span class="token punctuation">(</span>common_message<span class="token punctuation">,</span> controller<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;in func invoke, type of controllor = [%s]&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    json_data <span class="token operator">=</span> common_message<span class="token punctuation">.</span>get_message_content<span class="token punctuation">(</span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
    <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>controller<span class="token punctuation">)</span> <span class="token keyword">is</span> multiprocessing<span class="token punctuation">.</span>synchronize<span class="token punctuation">.</span>Event<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;controller is multiprocessing.synchronize.Event!!!&quot;</span><span class="token punctuation">)</span>
        ne_sn <span class="token operator">=</span> common_message<span class="token punctuation">.</span>ne_sn
        task_id <span class="token operator">=</span> common_message<span class="token punctuation">.</span>task_id
        <span class="token keyword">if</span> <span class="token keyword">not</span> ne_sn<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;can not find the ne_id=%s&quot;</span> <span class="token operator">%</span><span class="token punctuation">(</span>common_message<span class="token punctuation">.</span>ne_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> response
        response_key <span class="token operator">=</span> get_ne_sn_task_id_response_key<span class="token punctuation">(</span>ne_sn<span class="token punctuation">,</span> task_id<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;[%s][%s] register waiting key into redis(%s)\n%s&quot;</span><span class="token punctuation">,</span>
                    common_message<span class="token punctuation">.</span>category<span class="token punctuation">,</span> common_message<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">,</span>
                    response_key<span class="token punctuation">,</span> json_data<span class="token punctuation">)</span>

        redis_conn <span class="token operator">=</span> redis_pool<span class="token punctuation">.</span>get_redis_conn<span class="token punctuation">(</span><span class="token punctuation">)</span>
        redis_conn<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>response_key<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token comment"># NE_SN_EVENT_DICT[ne_sn] = controllor</span>

        logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;call event's wait method&quot;</span><span class="token punctuation">)</span>
        <span class="token comment"># REQUEST_QUEUE.put(json_data)</span>
        send_msg_to_devmd<span class="token punctuation">(</span>json_data<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
        <span class="token comment"># NE_SN_EVENT_DICT[ne_sn].wait()</span>
        wait_seq <span class="token operator">=</span> <span class="token number">0</span>
        timeout <span class="token operator">*=</span> <span class="token number">100</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> redis_conn<span class="token punctuation">.</span>get<span class="token punctuation">(</span>response_key<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> wait_seq <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;timeout = %d, wait_seq = %d&quot;</span><span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> wait_seq<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;</span> timeout <span class="token operator">&lt;</span> wait_seq<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            wait_seq <span class="token operator">+=</span> <span class="token number">1</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span>

        logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;got notify from handle response method&quot;</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> redis_conn<span class="token punctuation">.</span>get<span class="token punctuation">(</span>response_key<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> response<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">&quot;no response is got since %dS&quot;</span> <span class="token operator">%</span><span class="token punctuation">(</span>timeout<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;got notify, move on, response is: &quot;</span> <span class="token operator">+</span> response<span class="token punctuation">)</span>
        redis_conn<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>response_key<span class="token punctuation">)</span>
        <span class="token comment"># del NE_SN_EVENT_DICT[ne_sn]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># REQUEST_QUEUE.put(json_data)</span>
        send_msg_to_devmd<span class="token punctuation">(</span>json_data<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>

    <span class="token keyword">return</span> response

</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>X<span class="token punctuation">:</span>\ba3\src\basite\device\ipc\dev_ipc<span class="token punctuation">.</span>py
将消息发送给设备

<span class="token keyword">def</span> <span class="token function">send_msg_to_devmd</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ipc <span class="token operator">=</span> SgIPC<span class="token punctuation">(</span>logger<span class="token operator">=</span>log<span class="token punctuation">)</span>
    ipc<span class="token punctuation">.</span>create_socket<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ipc<span class="token punctuation">.</span>set_timeout<span class="token punctuation">(</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'send to devmd, message:\n%s'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
    ret <span class="token operator">=</span> ipc<span class="token punctuation">.</span>send_message<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    ipc<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> ret


</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>IPC 通信
X<span class="token punctuation">:</span>\ba3\src\basite\common\sg_ipc<span class="token punctuation">.</span>py

<span class="token keyword">class</span> <span class="token class-name">SgIPC</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> so_name<span class="token operator">=</span><span class="token string">&quot;devmd&quot;</span><span class="token punctuation">,</span> so_path<span class="token operator">=</span>RUN_DIR<span class="token punctuation">,</span> logger<span class="token operator">=</span>defLog<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>so_path <span class="token operator">=</span> so_path
        self<span class="token punctuation">.</span>so_name <span class="token operator">=</span> so_name
        self<span class="token punctuation">.</span>so_file <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>md_socket <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>sock_addr <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>so_file_last_modified_time <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>log <span class="token operator">=</span> logger

    <span class="token keyword">def</span> <span class="token function">_get_so_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>so_path<span class="token punctuation">,</span> name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_get_srv_sockaddr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> srv_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># print '''Read peer port from file '''</span>
        peer_port_file <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_so_file<span class="token punctuation">(</span>srv_name<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>peer_port_file<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> IOError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'read pid of [%s] failure, File Error: %s'</span><span class="token punctuation">,</span> srv_name<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        sockaddr <span class="token operator">=</span> f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        # 什么时候写的devmd，需要查看代码
        [root@ba run]# pwd
        /ba/var/run
        [root@ba run]# ls
        10.1  11.1  14.2  19.2  20.2  21.2  25.1  26.1  6.1  7.1  9.1
        10.2  11.2  19.1  20.1  21.1  24.1  25.2  26.2  6.2  7.2  devmd
        [root@ba run]# cat devmd 
        ('127.0.0.1', 38658)
        [root@ba run]# 

        [root@ba run]# python 
        Python 2.7.11 (default, Jun 14 2018, 02:02:08) 
        [GCC 4.4.7 20120313 (Red Hat 4.4.7-3)] on linux2
        Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
        &gt;&gt;&gt; import os
        &gt;&gt;&gt; import time
        &gt;&gt;&gt; print(time.ctime(os.path.getmtime(&quot;/ba/var/run/devmd&quot;)))
        Thu Feb 13 08:53:23 2020
        &gt;&gt;&gt; exit()
        &quot;&quot;&quot;</span>

        <span class="token keyword">return</span> sockaddr
    
    <span class="token keyword">def</span> <span class="token function">check_sockaddr_changed</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        so_file_last_modified_time <span class="token operator">=</span> time<span class="token punctuation">.</span>ctime<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getmtime<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_get_so_file<span class="token punctuation">(</span>self<span class="token punctuation">.</span>so_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>so_file_last_modified_time <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> \
                        so_file_last_modified_time <span class="token operator">!=</span> self<span class="token punctuation">.</span>so_file_last_modified_time<span class="token punctuation">:</span>
            
            self<span class="token punctuation">.</span>sock_addr <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_srv_sockaddr<span class="token punctuation">(</span>self<span class="token punctuation">.</span>so_name<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>so_file_last_modified_time <span class="token operator">=</span> so_file_last_modified_time
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># logger.debug(&quot;old sock_addr is %s, new sock_addr is %s&quot; %(self.sock_addr, sock_addr))</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">create_socket</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;so_name is %s&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>so_name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>sock_addr <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;sock address of %s is None, get it again&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>so_name<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>check_sockaddr_changed<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>md_socket<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>md_socket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> msg<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">&quot;socket create failed, %s&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token punctuation">,</span> msg

        self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>sock_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;connect to %s&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>sock_addr<span class="token punctuation">)</span>
        <span class="token comment"># md_socket.send(in_buf)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">receive_message</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            flag<span class="token punctuation">,</span> out_buf <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> msg<span class="token punctuation">:</span>
            flag<span class="token punctuation">,</span> out_buf <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> msg
        <span class="token keyword">return</span> flag<span class="token punctuation">,</span> out_buf

    <span class="token keyword">def</span> <span class="token function">set_timeout</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">send_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">&quot;to close connection to devmd&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>            
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>md_socket<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SHUT_RDWR<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>md_socket <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> msg<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>log<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">connect_to_devmd</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  
        <span class="token comment"># It's for EVENT receive process</span>
        self<span class="token punctuation">.</span>create_socket<span class="token punctuation">(</span><span class="token punctuation">)</span>        
        self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_KEEPALIVE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_TCP<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>TCP_KEEPIDLE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_TCP<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>TCP_KEEPINTVL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_TCP<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>TCP_KEEPCNT<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>settimeout<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>md_socket<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>

</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0a996f13.js" defer></script><script src="/assets/js/2.4c21bbc0.js" defer></script><script src="/assets/js/31.d48daed0.js" defer></script>
  </body>
</html>
