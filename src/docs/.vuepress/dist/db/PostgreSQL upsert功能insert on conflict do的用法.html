<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>背景 | 知识库</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="知识库">
    <link rel="preload" href="/assets/css/0.styles.fda5222c.css" as="style"><link rel="preload" href="/assets/js/app.d2153a58.js" as="script"><link rel="preload" href="/assets/js/2.f0460cba.js" as="script"><link rel="preload" href="/assets/js/11.c19cff97.js" as="script"><link rel="prefetch" href="/assets/js/10.69f86308.js"><link rel="prefetch" href="/assets/js/12.6bbcd3cf.js"><link rel="prefetch" href="/assets/js/13.062b5025.js"><link rel="prefetch" href="/assets/js/14.ba8c468c.js"><link rel="prefetch" href="/assets/js/15.27a25f21.js"><link rel="prefetch" href="/assets/js/16.5f5416f2.js"><link rel="prefetch" href="/assets/js/17.16dde1b0.js"><link rel="prefetch" href="/assets/js/18.844f2031.js"><link rel="prefetch" href="/assets/js/19.d79810a2.js"><link rel="prefetch" href="/assets/js/20.9d308145.js"><link rel="prefetch" href="/assets/js/21.be4987e0.js"><link rel="prefetch" href="/assets/js/22.f9190ad3.js"><link rel="prefetch" href="/assets/js/23.e3e85bce.js"><link rel="prefetch" href="/assets/js/24.45f4fe84.js"><link rel="prefetch" href="/assets/js/25.23a61867.js"><link rel="prefetch" href="/assets/js/26.93033efc.js"><link rel="prefetch" href="/assets/js/27.626f6b7a.js"><link rel="prefetch" href="/assets/js/28.da3ee322.js"><link rel="prefetch" href="/assets/js/29.1bb4f92b.js"><link rel="prefetch" href="/assets/js/3.e0082f21.js"><link rel="prefetch" href="/assets/js/30.7c1f5670.js"><link rel="prefetch" href="/assets/js/31.cac13ca2.js"><link rel="prefetch" href="/assets/js/32.4e80a29c.js"><link rel="prefetch" href="/assets/js/33.861fb333.js"><link rel="prefetch" href="/assets/js/34.6ddb59bd.js"><link rel="prefetch" href="/assets/js/35.48ac4a67.js"><link rel="prefetch" href="/assets/js/36.abe42e8e.js"><link rel="prefetch" href="/assets/js/37.17b0f147.js"><link rel="prefetch" href="/assets/js/38.7c542118.js"><link rel="prefetch" href="/assets/js/39.b477e6a4.js"><link rel="prefetch" href="/assets/js/4.49417740.js"><link rel="prefetch" href="/assets/js/40.651a1127.js"><link rel="prefetch" href="/assets/js/41.a05a7492.js"><link rel="prefetch" href="/assets/js/42.de855ada.js"><link rel="prefetch" href="/assets/js/43.528a9853.js"><link rel="prefetch" href="/assets/js/44.0c78865e.js"><link rel="prefetch" href="/assets/js/45.ff37ebb2.js"><link rel="prefetch" href="/assets/js/5.2004da03.js"><link rel="prefetch" href="/assets/js/6.529fa2f9.js"><link rel="prefetch" href="/assets/js/7.73a02948.js"><link rel="prefetch" href="/assets/js/8.9cecee70.js"><link rel="prefetch" href="/assets/js/9.3c9f4cbf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fda5222c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">知识库</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/python/" class="nav-link">
  python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/talk.html" class="nav-link">
  talk
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">
  other
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/wxjweb" target="_blank" rel="noopener noreferrer" class="nav-link external">
  FAQ
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/python/" class="nav-link">
  python
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/talk.html" class="nav-link">
  talk
</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">
  other
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/wxjweb" target="_blank" rel="noopener noreferrer" class="nav-link external">
  FAQ
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>welcome</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Frame</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>DB</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db/PostgreSQL序列.html" class="sidebar-link">PostgreSQL序列(SEQUENCE)</a></li><li><a href="/db/PostgreSQL按照自定义字段值顺序排序.html" class="sidebar-link">PostgreSQL按照自定义(字段值)顺序排序</a></li><li><a href="/db/PostgreSQL upsert功能insert on conflict do的用法.html" class="active sidebar-link">PostgreSQL upsert功能(insert on conflict do)的用法</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Leetcode</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tools</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Other</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h3> <p>PostgreSQL 9.5 引入了一项新功能，UPSERT(insert on conflict do)，当插入遇到约束错误时，直接返回，或者改为执行UPDATE。</p> <h3 id="语法如下"><a href="#语法如下" class="header-anchor">#</a> 语法如下</h3> <div class="language- extra-class"><pre class="language-text"><code>Command:     INSERT  
Description: create new rows in a table  
Syntax:  
[ WITH [ RECURSIVE ] with_query [, ...] ]  
INSERT INTO table_name [ AS alias ] [ ( column_name [, ...] ) ]  
    { DEFAULT VALUES | VALUES ( { expression | DEFAULT } [, ...] ) [, ...] | query }  
    [ ON CONFLICT [ conflict_target ] conflict_action ]  
    [ RETURNING * | output_expression [ [ AS ] output_name ] [, ...] ]  
  
where conflict_target can be one of:  
  
    ( { index_column_name | ( index_expression ) } [ COLLATE collation ] [ opclass ] [, ...] ) [ WHERE index_predicate ]  
    ON CONSTRAINT constraint_name  
  
and conflict_action is one of:  
  
    DO NOTHING  
    DO UPDATE SET { column_name = { expression | DEFAULT } |  
                    ( column_name [, ...] ) = ( { expression | DEFAULT } [, ...] ) |  
                    ( column_name [, ...] ) = ( sub-SELECT )  
                  } [, ...]  
              [ WHERE condition ]  
</code></pre></div><p>PostgreSQL 9.5以前的版本，可以通过函数，或者with语法来实现UPSERT类似的功能。</p> <h3 id="_9-5-upsert用法举例"><a href="#_9-5-upsert用法举例" class="header-anchor">#</a> 9.5+ UPSERT用法举例</h3> <p>创建一张测试表，其中一个字段为唯一键或者主键。</p> <div class="language- extra-class"><pre class="language-text"><code>create table test(id int primary key, info text, crt_time timestamp);  
</code></pre></div><ol><li>不存在则插入，存在则更新</li></ol> <div class="language- extra-class"><pre class="language-text"><code>test03=# insert into test values (1,'test',now()) on conflict (id) do update set info=excluded.info,crt_time=excluded.crt_time;  
INSERT 0 1  
  
test03=# select * from test;  
 id | info |          crt_time            
----+------+----------------------------  
  1 | test | 2017-04-24 15:27:25.393948  
(1 row)  
  
test03=# insert into test values (1,'hello digoal',now()) on conflict (id) do update set info=excluded.info,crt_time=excluded.crt_time;  
INSERT 0 1  
  
test03=# select * from test;  
 id |     info     |          crt_time            
----+--------------+----------------------------  
  1 | hello digoal | 2017-04-24 15:27:39.140877  
(1 row)  
</code></pre></div><ol start="2"><li>不存在则插入，存在则直接返回(不做任何处理)</li></ol> <div class="language- extra-class"><pre class="language-text"><code>test03=# insert into test values (1,'hello digoal',now()) on conflict (id) do nothing;  
INSERT 0 0  
test03=# insert into test values (1,'pu',now()) on conflict (id) do nothing;  
INSERT 0 0  
test03=# insert into test values (2,'pu',now()) on conflict (id) do nothing;  
INSERT 0 1  
test03=# select * from test;  
 id |     info     |          crt_time            
----+--------------+----------------------------  
  1 | hello digoal | 2017-04-24 15:27:39.140877  
  2 | pu           | 2017-04-24 15:28:20.37392  
(2 rows)  
</code></pre></div><h3 id="_9-5-upsert用法举例-2"><a href="#_9-5-upsert用法举例-2" class="header-anchor">#</a> 9.5- UPSERT用法举例</h3> <p>用户可以根据实际需求，使用不同的方法</p> <ol><li>函数</li></ol> <div class="language- extra-class"><pre class="language-text"><code>test03=# create or replace function f_upsert(int,text,timestamp) returns void as $$  
declare  
  res int;  
begin  
  update test set info=$2,crt_time=$3 where id=$1;  
  if not found then  
    insert into test (id,info,crt_time) values ($1,$2,$3);  
  end if;  
  exception when others then  
    return;  
end;  
$$ language plpgsql strict;  
CREATE FUNCTION  
  
test03=# select f_upsert(1,'digoal',now()::timestamp);  
 f_upsert   
----------  
   
(1 row)  
  
test03=# select * from test;  
 id |  info  |          crt_time            
----+--------+----------------------------  
  2 | pu     | 2017-04-24 15:28:20.37392  
  1 | digoal | 2017-04-24 15:31:29.254325  
(2 rows)  
  
test03=# select f_upsert(1,'digoal001',now()::timestamp);  
 f_upsert   
----------  
   
(1 row)  
  
test03=# select * from test;  
 id |   info    |         crt_time            
----+-----------+---------------------------  
  2 | pu        | 2017-04-24 15:28:20.37392  
  1 | digoal001 | 2017-04-24 15:31:38.0529  
(2 rows)  
  
test03=# select f_upsert(3,'hello',now()::timestamp);  
 f_upsert   
----------  
   
(1 row)  
  
test03=# select * from test;  
 id |   info    |         crt_time            
----+-----------+---------------------------  
  2 | pu        | 2017-04-24 15:28:20.37392  
  1 | digoal001 | 2017-04-24 15:31:38.0529  
  3 | hello     | 2017-04-24 15:31:49.14291  
(3 rows)  
</code></pre></div><ol start="2"><li>WITH语法，用法1</li></ol> <div class="language- extra-class"><pre class="language-text"><code>create table test(id int primary key, info text, crt_time timestamp); 
</code></pre></div><p>存在则更新，不存在则插入。</p> <div class="language- extra-class"><pre class="language-text"><code>with upsert as (update test set info=$info,crt_time=$crt_time where id=$id returning *) insert into test select $id,$info,$crt_time where not exists (select 1 from upsert where id=$id); 
</code></pre></div><p>替换变量，进行测试</p> <div class="language- extra-class"><pre class="language-text"><code>with upsert as (update test set info='test',crt_time=now() where id=1 returning *) insert into test select 1,'test',now() where not exists (select 1 from upsert where id=1);    
</code></pre></div><p>同时插入一条不存在的值，只有一个会话成功，另一个会话会报PK约束错误。</p> <ol start="3"><li>WITH语法，用法2</li></ol> <p>即使表没有PK或者唯一约束，也能保证并发。</p> <div class="language- extra-class"><pre class="language-text"><code>create table test(id int, info text, crt_time timestamp);  
</code></pre></div><p>3.1 对于记录不存在，可以保证只有一个session插入数据，对于同一条数据更新，先来的session会lock着记录，后来的session会wait。</p> <div class="language- extra-class"><pre class="language-text"><code>with     
  w1 as(select ('x'||substr(md5('$id'),1,16))::bit(64)::bigint as tra_id),    
  upsert as (update test set info=$info,crt_time=$crt_time where id=$id returning *)    
  insert into test select $id, $info, $crt_time from w1     
    where pg_try_advisory_xact_lock(tra_id) and not exists (select 1 from upsert where id=$id);    
</code></pre></div><p>替换变量，进行测试</p> <div class="language- extra-class"><pre class="language-text"><code>with     
  w1 as(select ('x'||substr(md5('1'),1,16))::bit(64)::bigint as tra_id),    
  upsert as (update test set info='digoal0123',crt_time=now() where id=1 returning *)    
  insert into test select 1, 'digoal0123', now() from w1     
    where pg_try_advisory_xact_lock(tra_id) and not exists (select 1 from upsert where id=1);    
  
INSERT 0 0  
  
test03=# select * from test;  
 id |    info    |         crt_time            
----+------------+---------------------------  
  2 | pu         | 2017-04-24 15:28:20.37392  
  3 | hello      | 2017-04-24 15:31:49.14291  
  1 | digoal0123 | 2017-04-24 15:31:38.0529  
(3 rows)  
  
with     
  w1 as(select ('x'||substr(md5('4'),1,16))::bit(64)::bigint as tra_id),    
  upsert as (update test set info='digoal0123',crt_time=now() where id=4 returning *)    
  insert into test select 4, 'digoal0123', now() from w1     
    where pg_try_advisory_xact_lock(tra_id) and not exists (select 1 from upsert where id=4);    
  
INSERT 0 1  
  
test03=# select * from test;  
 id |    info    |          crt_time            
----+------------+----------------------------  
  2 | pu         | 2017-04-24 15:28:20.37392  
  3 | hello      | 2017-04-24 15:31:49.14291  
  1 | digoal0123 | 2017-04-24 15:31:38.0529  
  4 | digoal0123 | 2017-04-24 15:38:39.801908  
(4 rows)  
</code></pre></div><p>3.2 对于记录不存在，可以保证只有一个session插入数据，对于同一条数据更新，先来的session会更新数据，后来的session不等待，直接失败。</p> <div class="language- extra-class"><pre class="language-text"><code>with w1 as(select ('x'||substr(md5('$id'),1,16))::bit(64)::bigint as tra_id),    
  upsert as (update test set info=$info,crt_time=$crt_time from w1 where pg_try_advisory_xact_lock(tra_id) and id=$id returning *)    
  insert into test select $id,$info,$crt_time from w1   
    where pg_try_advisory_xact_lock(tra_id) and not exists (select 1 from upsert where id=$id);     
</code></pre></div><p>替换变量，进行测试</p> <div class="language- extra-class"><pre class="language-text"><code>with w1 as(select ('x'||substr(md5('1'),1,16))::bit(64)::bigint as tra_id),    
  upsert as (update test set info='test',crt_time=now() from w1 where pg_try_advisory_xact_lock(tra_id) and id=1 returning *)    
  insert into test select 1,'test',now() from w1   
    where pg_try_advisory_xact_lock(tra_id) and not exists (select 1 from upsert where id=1);    
  
INSERT 0 0  
  
test03=# select * from test;  
 id |    info    |          crt_time            
----+------------+----------------------------  
  2 | pu         | 2017-04-24 15:28:20.37392  
  3 | hello      | 2017-04-24 15:31:49.14291  
  4 | digoal0123 | 2017-04-24 15:42:50.912887  
  1 | test       | 2017-04-24 15:44:44.245167  
(4 rows)  
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/db/PostgreSQL按照自定义字段值顺序排序.html" class="prev">
        PostgreSQL按照自定义(字段值)顺序排序
      </a></span> <span class="next"><a href="/leetcode/20200606 无重复字符的最长子串.html">
        20200606 无重复字符的最长子串
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d2153a58.js" defer></script><script src="/assets/js/2.f0460cba.js" defer></script><script src="/assets/js/11.c19cff97.js" defer></script>
  </body>
</html>
